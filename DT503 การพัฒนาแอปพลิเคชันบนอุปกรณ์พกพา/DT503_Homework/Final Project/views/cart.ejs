<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Cache-Control"
      content="no-store, no-cache, must-revalidate, max-age=0"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>NJTK Bookstore</title>

    <link rel="icon" type="image/png" href="/images/NJTK_Logo_small.png" />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- CSS -->
    <link rel="stylesheet" href="/stylesheets/styles.css" />
    <link rel="stylesheet" href="/stylesheets/cardBook.css" />
    <link rel="stylesheet" href="/stylesheets/scrollbar.css" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;400;500;700&family=Noto+Sans+Thai:wght@300;400;600&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "theme-sage": "#809671" /* Primary: ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÉ‡∏ö‡πÑ‡∏°‡πâ */,
              "theme-olive": "#B3B792" /* Secondary: ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏∞‡∏Å‡∏≠‡∏Å/‡∏ó‡∏≠‡∏á */,
              "theme-cream": "#E5E0D8" /* Background: ‡∏™‡∏µ‡∏Ñ‡∏£‡∏µ‡∏°‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© */,
              "theme-charcoal": "#2A3328" /* Text: ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡πÄ‡∏Ç‡πâ‡∏°‡∏≠‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */,
              "theme-paper": "#F5F3EF" /* Card: ‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏ô‡∏ß‡∏• */,
            },
            fontFamily: {
              playfair: ['"Playfair Display"', "serif"],
              sans: ['"DM Sans"', '"Noto Sans Thai"', "sans-serif"],
            },
            boxShadow: {
              soft: "0 10px 40px -10px rgba(0,0,0,0.08)",
              glass: "0 8px 32px 0 rgba(31, 38, 135, 0.07)",
            },
          },
        },
      };
    </script>
  </head>

  <body class="bg-theme-cream min-h-screen font-sans">
  <!-- Navbar -->
  <nav id="navbar" class="fixed w-full z-50 transition-all duration-500 py-4 px-6 md:px-12 bg-transparent">
    <div
      class="max-w-7xl mx-auto backdrop-blur-md bg-white/60 border border-white/40 rounded-2xl shadow-glass px-6 py-3 flex justify-between items-center">
      <!-- Logo -->
      <a href="/" class="flex items-center gap-2 group">
        <img class="w-[75px]" src="/images/NJTK_Logo_full.png" alt="NJTK Logo" />
      </a>

      <!-- Desktop Menu -->
      <div class="hidden md:flex items-center space-x-8">
        <a href="#home"
          class="text-sm font-bold uppercase tracking-widest hover:text-theme-sage transition-colors relative after:content-[''] after:absolute after:-bottom-1 after:left-0 after:w-0 after:h-0.5 after:bg-theme-sage after:transition-all hover:after:w-full">Home</a>
        <a href="#shop"
          class="text-sm font-bold uppercase tracking-widest hover:text-theme-sage transition-colors relative after:content-[''] after:absolute after:-bottom-1 after:left-0 after:w-0 after:h-0.5 after:bg-theme-sage after:transition-all hover:after:w-full">Shop</a>
        <a href="/about"
          class="text-sm font-bold uppercase tracking-widest hover:text-theme-sage transition-colors relative after:content-[''] after:absolute after:-bottom-1 after:left-0 after:w-0 after:h-0.5 after:bg-theme-sage after:transition-all hover:after:w-full">About</a>
      </div>

      <!-- Icons & Mobile Button -->
      <div class="flex items-center gap-6">
        <a href="/cart" class="relative cursor-pointer group">
          <i class="fa-solid fa-bag-shopping text-xl hover:text-theme-sage transition-colors"></i>
          <span id="cart-count"
            class="absolute -top-2 -right-2 bg-theme-sage text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full group-hover:scale-110 transition-transform">0</span>
        </a>
        <!-- User Logic (EJS) -->

<% if (typeof user !== 'undefined' && user) { %>

  <!-- ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Login ‡πÅ‡∏•‡πâ‡∏ß -->
  <div class="hidden md:flex items-center gap-3 pl-4 border-l border-gray-300/60">

    <a href="/profile" class="flex items-center gap-2 group">
      <div class="flex flex-col">
        <span 
          class="text-xs font-bold text-gray-700 group-hover:text-theme-sage transition-colors truncate max-w-[100px]">
          <%= user.fullname %> 
        </span>

        <span class="text-[10px] text-gray-500 truncate max-w-[100px]">
          <%= user.email %>
        </span>
      </div>
    </a>

    <!-- Logout -->
    <a href="/logout"
      class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 text-gray-500 
             hover:bg-red-50 hover:text-red-500 transition-all shadow-sm"
      title="Logout">
      <i class="fa-solid fa-arrow-right-from-bracket text-xs"></i>
    </a>
  </div>

<% } else { %>

  <!-- Guest (‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Login) -->
  <a href="/login"
    class="px-5 py-2 bg-theme-sage text-white text-sm rounded-full font-bold shadow-md 
           hover:bg-theme-charcoal transition-colors hidden md:inline-block">
    Login
  </a>

<% } %>

              <button id="mobile-menu-btn" class="md:hidden text-2xl focus:outline-none">
                <i class="fa-solid fa-bars-staggered"></i>
              </button>
      </div>
    </div>

    <!-- Mobile Menu Overlay -->
    <div id="mobile-menu"
      class="fixed inset-0 bg-theme-cream/95 backdrop-blur-xl z-40 transform translate-x-full transition-transform duration-300 md:hidden flex flex-col items-center justify-center space-y-8">
      <button id="close-menu" class="absolute top-8 right-8 text-3xl text-theme-sage">
        <i class="fa-solid fa-xmark"></i>
      </button>
      <a href="#home" class="text-3xl font-playfair font-bold text-theme-charcoal hover:text-theme-sage">Home</a>
      <a href="#shop" class="text-3xl font-playfair font-bold text-theme-charcoal hover:text-theme-sage">Shop</a>
      <a href="/about" class="text-3xl font-playfair font-bold text-theme-charcoal hover:text-theme-sage">About</a>
      <a href="/cart" class="text-3xl font-playfair font-bold text-theme-charcoal hover:text-theme-sage">Cart</a>
      <% if (typeof user !== 'undefined' && user) { %>
      <a href="/profile" class="text-3xl font-playfair font-bold text-theme-charcoal hover:text-theme-sage">My Profile</a>
      <a href="/logout" class="px-8 py-3 bg-theme-sage text-white rounded-full font-bold shadow-lg">Logout</a>
      <% } else { %>
        <a href="/login" class="px-8 py-3 bg-theme-sage text-white rounded-full font-bold shadow-lg">Login</a>
        <% } %>
    </div>
  </nav>

    <main class="pt-28 pb-16 min-h-screen px-6 md:px-12">
      <!-- Header -->
      <header class="py-10 text-center">
        <h1 class="text-4xl font-playfair font-bold text-theme-charcoal">
          Your Cart
        </h1>
        <p class="text-gray-600">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>
      </header>

      <!-- Cart Container -->
      <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-8 mb-20">
        <!-- Case 1: ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å Server Side EJS) -->
        <% if (!cart || cart.length===0) { %>
        <div id="empty-cart-msg" class="text-center py-16 text-gray-500">
          <i class="fa-solid fa-cart-shopping text-6xl mb-6 opacity-30"></i>
          <p class="text-xl font-semibold">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</p>
          <a
            href="/"
            class="mt-4 inline-block text-theme-sage font-bold hover:underline"
          >
            ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠
          </a>
        </div>

        <!-- Case 2: ‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
        <% } else { %> <% let total=0 %>

        <!-- Cart List Container -->
<div id="cart-items-container" class="space-y-6">

  <% cart.forEach(item => { %>

    <% 
      // ‡∏ñ‡πâ‡∏≤ login ‚Üí memberPrice = ‡∏•‡∏î 10%
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà login ‚Üí memberPrice = ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ï‡πá‡∏°
      const isLoggedIn = typeof user !== 'undefined' && user;
      const unitPrice = isLoggedIn 
            ? Math.round(item.sellPrice * 0.9)
            : item.sellPrice;

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô
      let itemTotal = item.qty * unitPrice;
      total += itemTotal;
    %>

    <!-- Cart Item Row -->
    <div
      class="cart-item flex gap-4 md:gap-6 items-center border-b pb-6 transition-all duration-300"
      id="row-<%= item.id %>"
      data-price="<%= unitPrice %>" 
    >
      <!-- Image -->
      <img
        src="<%= item.imageURL %>"
        class="w-20 h-28 md:w-24 md:h-32 object-cover rounded shadow"
      />

      <!-- Info -->
      <div class="flex-1">
        <h3 class="text-lg md:text-xl font-bold text-theme-charcoal">
          <%= item.bookname %>
        </h3>
        <p class="text-sm text-gray-600">by <%= item.author %></p>

        <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏ñ‡πâ‡∏≤ login ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤ -->
        <% if (isLoggedIn) { %>
            <p class="text-theme-sage font-bold mt-1 text-sm md:text-base">
              ‡∏ø<%= unitPrice.toLocaleString() %> / ‡∏ä‡∏¥‡πâ‡∏ô
              <span class="text-gray-400 line-through text-xs ml-2">
                ‡∏ø<%= item.sellPrice.toLocaleString() %>
              </span>
            </p>
        <% } else { %>
            <p class="text-theme-sage font-bold mt-1 text-sm md:text-base">
              ‡∏ø<%= item.sellPrice.toLocaleString() %> / ‡∏ä‡∏¥‡πâ‡∏ô
            </p>
        <% } %>

        <!-- Item Total Display -->
        <p class="text-gray-700 mt-1 font-semibold text-sm md:text-base">
          ‡∏£‡∏ß‡∏°: ‡∏ø<span id="item-total-<%= item.id %>">
            <%= itemTotal.toLocaleString() %>
          </span>
        </p>
      </div>

      <!-- Quantity Controls -->
      <div class="flex items-center gap-2 md:gap-3 bg-gray-100 rounded-lg p-1">
        <button
          class="w-8 h-8 flex items-center justify-center bg-white rounded shadow text-gray-600 hover:text-red-500 font-bold"
          onclick="updateQty('<%= item.id %>', -1)"
        >
          ‚àí
        </button>

        <span
          class="text-lg font-bold w-6 text-center text-theme-charcoal"
          id="qty-<%= item.id %>"
        >
          <%= item.qty %>
        </span>

        <button
          class="w-8 h-8 flex items-center justify-center bg-white rounded shadow text-gray-600 hover:text-green-600 font-bold"
          onclick="updateQty('<%= item.id %>', 1)"
        >
          +
        </button>
      </div>

      <!-- Delete Button -->
      <button
        onclick="removeItem('<%= item.id %>' )"
        class="text-gray-400 hover:text-red-500 text-xl ml-2 md:ml-4 transition-colors"
      >
        <i class="fa-solid fa-trash"></i>
      </button>
    </div>

  <% }) %>

</div>

        <!-- Cart Summary -->
        <div id="cart-summary" class="text-right pt-6">
          <p class="text-xl font-bold text-theme-charcoal">
            ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:
            <!-- ‡πÉ‡∏™‡πà id ‡πÉ‡∏´‡πâ grand total ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï -->
            <span class="text-theme-sage text-3xl ml-2"
              >‡∏ø<span id="grand-total">
                <%= total.toLocaleString() %>
              </span></span
            >
          </p>
<br>
          <a href="/cart/checkout"
            class="mt-6 px-8 py-3 bg-theme-sage text-white rounded-full font-bold text-lg hover:bg-theme-charcoal transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-1"
          >
            Checkout <i class="fa-solid fa-arrow-right ml-2"></i>
          </a>
        </div>

        <!-- Empty Cart Message (‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡∏à‡∏∞‡πÇ‡∏ú‡∏•‡πà‡∏°‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏î) -->
        <div id="js-empty-msg" class="hidden text-center py-16 text-gray-500">
          <i class="fa-solid fa-cart-shopping text-6xl mb-6 opacity-30"></i>
          <p class="text-xl font-semibold">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</p>
          <a
            href="/"
            class="mt-4 inline-block text-theme-sage font-bold hover:underline"
          >
            ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠
          </a>
        </div>

        <% } %>
      </div>
    </main>
    <!-- JavaScript Logic -->
    <script src="/javascripts/navbar.js"></script>
    <script src="/javascripts/scrollbar.js"></script>
    <script src="/javascripts/cart.js"></script>
    <script>
      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      function updateQty(id, change) {
        const qtySpan = document.getElementById(`qty-${id}`);
        const row = document.getElementById(`row-${id}`);

        let currentQty = parseInt(qtySpan.innerText);
        let newQty = currentQty + change;

        if (newQty < 1) return;

        qtySpan.innerText = newQty;

        const price = parseInt(row.getAttribute("data-price"));
        const newItemTotal = price * newQty;
        document.getElementById(`item-total-${id}`).innerText =
          newItemTotal.toLocaleString();

        recalculateGrandTotal();

        // üî• ‡∏™‡πà‡∏á API update ‡πÑ‡∏õ server
        fetch("/cart/update", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            id: parseInt(id), // ‡∏ï‡πâ‡∏≠‡∏á parseInt !!!
            qty: newQty,
          }),
        })
          .then((res) => res.json())
          .then((data) => console.log("UPDATED:", data))
          .catch((err) => console.error(err));
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      function removeItem(id) {
        if (!confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;

        const row = document.getElementById(`row-${id}`);
        if (row) {
          row.remove();
          recalculateGrandTotal();
          checkIfEmpty();
        }

        // üî• ‡∏™‡πà‡∏á API ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        fetch("/cart/remove", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ id: id }),
        })
          .then((res) => res.json())
          .then((data) => console.log("REMOVED:", data))
          .catch((err) => console.error(err));
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥
      function recalculateGrandTotal() {
        let total = 0;
        const rows = document.querySelectorAll(".cart-item");

        rows.forEach((row) => {
          const price = parseInt(row.getAttribute("data-price"));
          // ‡∏´‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≤‡∏Å span qty ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô row ‡∏ô‡∏±‡πâ‡∏ô
          const qtyText = row.querySelector(`[id^="qty-"]`).innerText;
          const qty = parseInt(qtyText);

          total += price * qty;
        });

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        document.getElementById("grand-total").innerText =
          total.toLocaleString();
      }

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
      function checkIfEmpty() {
        const rows = document.querySelectorAll(".cart-item");
        if (rows.length === 0) {
          document.getElementById("cart-items-container").style.display =
            "none";
          document.getElementById("cart-summary").style.display = "none";
          document.getElementById("js-empty-msg").classList.remove("hidden");
        }
      }
    </script>
  </body>
</html>
